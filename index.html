<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style type="text/css">
            body {
                font-family: sans-serif;
                font-size: 13px;
            }
            
            hr {
                border-bottom: 1px solid #6F6F6F;
                width: 80%;
                margin: 20px auto;
            }
            
            p {
                font-weight: bold;
                margin-top: 10px;
            }
        </style>
        <title>New IME Project</title>
    </head>
    <body>
        <div data-role="page" id="foo">
            <p>
                Test for iPad/iPhone/Android only.
            </p>
            <div data-role="header">
                Let's touch Morse key device!
            </div>
            <div data-role="content">
                <textarea id="input-box" rows=1 cols=36>
                </textarea>
                <hr>
                <div class="ui-grid-c">
                    <div class="ui-block-a">
                        <img src="res/morse_off.png" width="100%" heigth="100%" id="morseinput" alt="">
                        </img><input type="button" value="OK" id="decision">
                        </input><input type="button" value="CANCEL" id="cancel">
                        </input><input type="button" value="a/A" id="slchange">
                        </input>
                    </div>
                    <div class="ui-block-b">
                        <div id="suggest">
                        </div>
                    </div>
                    <div class="ui-block-c">
                        <div id="suggest_num">
                        </div>
                    </div>
                    <div class="ui-block-d">
                        <div id="suggest_etc">
                        </div>
                    </div>
                </div>
                </div>
            </div>
            </body>
            <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.css" />
            <script type="text/javascript" src="http://code.jquery.com/jquery-1.5.2.min.js">
            </script>
            <script type="text/javascript" src="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.js">
            </script>
            <script type="text/javascript">
                $(function(){
                    //$("suggest").hide();
                    
                    morse_queue = "";
                    isAlphaSmall = true;
                    for (key in morsedatas_alpha_small) {
                        morsedatas_alpha[key] = morsedatas_alpha_small[key];
                    }
                    
                    for (key in morsedatas_alpha) {
                        morsedatas[key] = morsedatas_alpha[key];
                    }
                    for (key in morsedatas_num) {
                        morsedatas[key] = morsedatas_num[key];
                    }
                    for (key in morsedatas_etc) {
                        morsedatas[key] = morsedatas_etc[key];
                    }
                    
                    $("#input-box").text("");
                    var morseTouchHandler = getMorseInputHandler();
                    var okTouchHandler = getOKInputHandler();
                    var cancelTouchHandler = getCANCELInputHandler();
                    var slchangeTouchHandler = getSLchangeInputHandler();
                    
                    $("#morseinput").bind("touchstart touchend mousedown mouseup", morseTouchHandler);
                    isMorseInput = false;
                    
                    $("#decision").bind("touchstart touchend mousedown mouseup", okTouchHandler);
                    $("#cancel").bind("touchstart touchend mousedown mouseup", cancelTouchHandler);
                    
                    $("#slchange").bind("touchstart touchend mousedown mouseup", slchangeTouchHandler);
                    
                });
                
                var morsedatas = {}
                var morsedatas_alpha = {}
                var isAlphaSmall = false;
                
                var morsedatas_alpha_large = {
                    "・ ー ": "A",
                    "ー ・ ・ ・ ": "B",
                    "ー ・ ー ・ ": "C",
                    "ー ・ ・ ": "D",
                    "・ ": "E",
                    "・ ・ ー ・ ": "F",
                    "ー ー ・ ": "G",
                    "・ ・ ・ ・ ": "H",
                    "・ ・ ": "I",
                    "・ ー ー ー ": "J",
                    "ー ・ ー ": "K",
                    "・ ー ・ ・ ": "L",
                    "ー ー ": "M",
                    "ー ・ ": "N",
                    "ー ー ー ": "O",
                    "・ ー ー ・ ": "P",
                    "ー ー ・ ー ": "Q",
                    "・ ー ・ ": "R",
                    "・ ・ ・ ": "S",
                    "ー ": "T",
                    "・ ・ ー ": "U",
                    "・ ・ ・ ー ": "V",
                    "・ ー ー ": "W",
                    "ー ・ ・ ー ": "X",
                    "ー ・ ー ー ": "Y",
                    "ー ー ・ ・ ": "Z"
                }
                
                var morsedatas_alpha_small = {
                    "・ ー ": "a",
                    "ー ・ ・ ・ ": "b",
                    "ー ・ ー ・ ": "c",
                    "ー ・ ・ ": "d",
                    "・ ": "e",
                    "・ ・ ー ・ ": "f",
                    "ー ー ・ ": "g",
                    "・ ・ ・ ・ ": "h",
                    "・ ・ ": "i",
                    "・ ー ー ー ": "j",
                    "ー ・ ー ": "k",
                    "・ ー ・ ・ ": "l",
                    "ー ー ": "m",
                    "ー ・ ": "n",
                    "ー ー ー ": "o",
                    "・ ー ー ・ ": "p",
                    "ー ー ・ ー ": "q",
                    "・ ー ・ ": "r",
                    "・ ・ ・ ": "s",
                    "ー ": "t",
                    "・ ・ ー ": "u",
                    "・ ・ ・ ー ": "v",
                    "・ ー ー ": "w",
                    "ー ・ ・ ー ": "x",
                    "ー ・ ー ー ": "y",
                    "ー ー ・ ・ ": "z"
                }
                
                var morsedatas_num = {
                    "ー ー ー ー ー ": "0",
                    "・ ー ー ー ー ": "1",
                    "・ ・ ー ー ー ": "2",
                    "・ ・ ・ ー ー ": "3",
                    "・ ・ ・ ・ ー ": "4",
                    "・ ・ ・ ・ ・ ": "5",
                    "ー ・ ・ ・ ・ ": "6",
                    "ー ー ・ ・ ・ ": "7",
                    "ー ー ー ・ ・ ": "8",
                    "ー ー ー ー ・ ": "9",
                }
                
                var morsedatas_etc = {
                    "・ ・ ・ ・ ・ ・ ": "SPACE",
                    "・ ー ・ ー ・ ー ": ".",
                    "ー ー ・ ・ ー ー ": ",",
                    "・ ・ ー ー ・ ・ ": "?",
                    "・ ・ ー ー ・ ": "!",
                    "・ ー ・ ー ・ ": "+",
                    "ー ・ ・ ・ ・ ー ": "-",
                    "ー ・ ・ ー ー ": "*",
                    "ー ・ ・ ー ・ ": "/",
                    "ー ・ ・ ・ ー ": "=",
                    "ー ・ ー ー ・ ": "(",
                    "ー ・ ー ー ・ ー ": ")",
                    "・ ー ー ー ー ・ ": "\`",
                    "・ ー ・ ・ ー ・ ": "\"",
                    "ー ー ー ・ ・ ・ ": ":",
                    "・ ー ー ・ ー ・ ": "@",
                    "・ ・ ・ ・ ・ ・ ・ ・ ": "HH",
                }
                
                function getOKInputHandler(){
                    return function(e){
                        e.preventDefault();
                        //var touch = e.touches[0];
                        var touch = e.originalEvent.touches[0];
                        if ((e.type == "touchend" || e.type == "mouseup") && morsedatas[morse_queue]) {
                            var tmpmsg = $("#input-box").val();
                            if (morsedatas[morse_queue] == "HH") {
                                var hhmsg = tmpmsg.slice(0, tmpmsg.length - 1);
                                $("#input-box").val(hhmsg);
                            }
                            else 
                                if (morsedatas[morse_queue] == "SPACE") {
                                    $("#input-box").val(tmpmsg + " ");
                                }
                                else {
                                    $("#input-box").val(tmpmsg + morsedatas[morse_queue]);
                                }
                            morse_queue = "";
                            $("#suggest").text("");
                            $("#suggest_num").text("");
                            $("#suggest_etc").text("");
                        }
                    }
                }
                
                function getCANCELInputHandler(){
                    return function(e){
                        e.preventDefault();
                        //var touch = e.touches[0];
                        var touch = e.originalEvent.touches[0];
                        if (e.type == "touchend" || e.type == "mouseup") {
                            morse_queue = "";
                            $("#suggest").text("");
                            $("#suggest_num").text("");
                            $("#suggest_etc").text("");
                        }
                    }
                }
                
                function getSLchangeInputHandler(){
                    return function(e){
                        e.preventDefault();
                        //var touch = e.touches[0];
                        var touch = e.originalEvent.touches[0];
                        if (e.type == "touchend" || e.type == "mouseup") {
                            isAlphaSmall = !isAlphaSmall;
                            morsedatas_alpha = null;
                            morsedatas_alpha = new Object();
                            
                            if (isAlphaSmall == true) {
                                for (key in morsedatas_alpha_small) {
                                    morsedatas_alpha[key] = morsedatas_alpha_small[key];
                                    morsedatas[key] = morsedatas_alpha_small[key];
                                }
                            }
                            else {
                                for (key in morsedatas_alpha_large) {
                                    morsedatas_alpha[key] = morsedatas_alpha_large[key];
                                    morsedatas[key] = morsedatas_alpha_large[key];
                                }
                            }
                        }
                    }
                }
                
                function getMorseInputHandler(){
                    //global var
                    //var tX, tY = 0;
                    //var sTime = 0;
                    
                    //if(isMorseInput) return;
                    
                    return function(e){
                        isMorseInput = true;
                        
                        e.preventDefault();
                        //var touch = e.touches[0];
                        var touch = e.originalEvent.touches[0];
                        if (e.type == "touchstart" || e.type == "mousedown") {
                            tX = touch.pageX;
                            tY = touch.pageY;
                            sTime = (new Date()).getTime();
                            //morse - on
                            reqestFunction(morse_on);
                        }
                        else 
                            if (e.type == "touchend" || e.type == "mouseup") {
                                var dt = (new Date()).getTime() - sTime;
                                if (dt < 300) {
                                    //ton
                                    morse_queue += '・ ';
                                }
                                else 
                                    if (dt > 300 && dt < 2000) {
                                        //tu-
                                        morse_queue += 'ー ';
                                    }
                                //morse - off
                                reqestFunction(morse_off);
                            }
                        //suggest
                        reqestFunction(morse_alpha_suggest);
                        reqestFunction(morse_num_suggest);
                        reqestFunction(morse_etc_suggest);
                        reqestFunction(is_morse_suggest);
                        isMorseInput = false;
                    }
                }
                
                function reqestFunction(func){
                    setTimeout(func, 3);
                }
                
                function morse_on(){
                    $("#morseinput").attr("src", "res/morse_on.png");
                }
                
                function morse_off(){
                    $("#morseinput").attr("src", "res/morse_off.png");
                }
                
                function morse_alpha_suggest(){
                    var suggests = [];
                    var tmpstr = "<ul>";
                    for (key in morsedatas_alpha) {
                        if (key.indexOf(morse_queue) == 0 && $.inArray(key, suggests) == -1) {
                            suggests.push(key);
                            var nextstr = key.slice(morse_queue.length - 1);
                            tmpstr += "<li>" + "<strong>" + morse_queue.fontcolor("red") + "</strong>" + nextstr + " => " + morsedatas_alpha[key] + "</li>";
                        }
                    }
                    tmpstr += "</ul>";
                    //$("#suggest").text(tmpstr);
                    $("#suggest").html(tmpstr);
                }
                
                function morse_num_suggest(){
                    var suggests = [];
                    var tmpstr = "<ul>";
                    for (key in morsedatas_num) {
                        if (key.indexOf(morse_queue) == 0 && $.inArray(key, suggests) == -1) {
                            suggests.push(key);
                            var nextstr = key.slice(morse_queue.length - 1);
                            tmpstr += "<li>" + "<strong>" + morse_queue.fontcolor("red") + "</strong>" + nextstr + " => " + morsedatas_num[key] + "</li>";
                        }
                    }
                    tmpstr += "</ul>";
                    $("#suggest_num").html(tmpstr);
                }
                
                function morse_etc_suggest(){
                    var suggests = [];
                    var tmpstr = "<ul>";
                    for (key in morsedatas_etc) {
                        if (key.indexOf(morse_queue) == 0 && $.inArray(key, suggests) == -1) {
                            suggests.push(key);
                            var nextstr = key.slice(morse_queue.length - 1);
                            tmpstr += "<li>" + "<strong>" + morse_queue.fontcolor("red") + "</strong>" + nextstr + " => " + morsedatas_etc[key] + "</li>";
                        }
                    }
                    tmpstr += "</ul>";
                    $("#suggest_etc").html(tmpstr);
                }
                
                function is_morse_suggest(){
                    var suggests = [];
                    for (key in morsedatas) {
                        if (key.indexOf(morse_queue) == 0 && $.inArray(key, suggests) == -1) {
                            suggests.push(key);
                        }
                    }
                    if (suggests.length == 0) {
                        morse_queue = "";
                    }
                }
            </script>
        </html>
